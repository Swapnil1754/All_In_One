{"ast":null,"code":"import { Observable, ReplaySubject, catchError, map, mergeMap, of, shareReplay, tap } from 'rxjs';\nimport { Account } from '../Domain/General-Domain/Account';\nimport { HttpParams } from '@angular/common/http';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"ngx-webstorage\";\nimport * as i3 from \"./Auth/state-storage.service\";\nimport * as i4 from \"@angular/router\";\nclass LoginServiceService {\n  constructor(httpclient, localStorageService, sessionStorageService, stateStorageService, router) {\n    this.httpclient = httpclient;\n    this.localStorageService = localStorageService;\n    this.sessionStorageService = sessionStorageService;\n    this.stateStorageService = stateStorageService;\n    this.router = router;\n    this.userIdentity = null;\n    this.authenticationState = new ReplaySubject(1);\n    this.url = \"http://localhost:9000/api/v1/login\";\n    this.url1 = \"http://localhost:9000/api/v1\";\n    this.url2 = \"http://localhost:9000/api\";\n  }\n  register(data) {\n    return this.httpclient.post(`${this.url1}/${\"register\"}`, data);\n  }\n  login(data, pass, remember) {\n    return this.httpclient.post(`${this.url}/${data}`, pass).pipe(map(response => this.authenticateUser(response.token, remember.rememberMe))).pipe(mergeMap(() => this.identity(data, true)));\n  }\n  googleLogin(googleToken) {\n    const queryParams = new HttpParams().set('token', googleToken);\n    console.log(\"Sanity\", queryParams);\n    return this.httpclient.get(`${this.url1}/${\"google\"}`, {\n      params: queryParams\n    });\n  }\n  fbLogin(name) {\n    const qParam = new HttpParams().set('name', name);\n    console.log(\"name\", name);\n    return this.httpclient.get(`${this.url1}/${\"facebook\"}`, {\n      params: qParam\n    });\n  }\n  authenticateUser(response, rememberMe) {\n    const jwt = response;\n    if (rememberMe) {\n      console.log(\"token1\", jwt);\n      this.localStorageService.store('authenticationToken', jwt);\n      this.sessionStorageService.clear('authenticationToken');\n    } else {\n      console.log(\"token2\", jwt);\n      this.sessionStorageService.store('authenticationToken', jwt);\n      this.localStorageService.clear('authenticationToken');\n    }\n  }\n  identity(data, force) {\n    if (!this.accountCache$ || force && data != null) {\n      this.accountCache$ = this.fetch(data).pipe(tap(account => {\n        this.authenticate(account);\n        this.navigateToStoredUrl();\n      }), shareReplay());\n    }\n    return this.accountCache$.pipe(catchError(() => of(null)));\n  }\n  authenticate(identity) {\n    this.userIdentity = identity;\n    console.log(\"id1\", this.userIdentity);\n    this.authenticationState.next(identity);\n    if (!identity) {\n      this.accountCache$ = null;\n    }\n  }\n  fetch(data) {\n    if (data != null) {\n      let x = this.httpclient.get(`${this.url1}/${\"fetch\"}/${data}`);\n      if (x !== null) {\n        x.subscribe(a => {\n          let b = a.userId;\n          console.log(\"id2\", b);\n          localStorage.setItem(\"userIdentity\", b);\n        });\n      }\n      return x;\n    } else {\n      return Observable < Account;\n    }\n  }\n  navigateToStoredUrl() {\n    // previousState can be set in the authExpiredInterceptor and in the userRouteAccessService\n    // if login is successful, go to stored previousState and clear previousState\n    const previousUrl = this.stateStorageService.getUrl();\n    if (previousUrl) {\n      this.stateStorageService.clearUrl();\n      this.router.navigateByUrl(previousUrl);\n    }\n  }\n  isAuthenticated() {\n    let userIdentity = localStorage.getItem(\"userIdentity\");\n    if (userIdentity !== null) {\n      console.log(\"id\", userIdentity);\n      return true;\n    } else {\n      console.log(\"else\", userIdentity);\n      return false;\n    }\n  }\n  out() {\n    return new Observable(observer => {\n      this.localStorageService.clear();\n      this.sessionStorageService.clear();\n      localStorage.removeItem(\"userIdentity\");\n      observer.complete();\n    });\n  }\n  logout() {\n    this.out().subscribe({\n      complete: () => this.authenticate(null)\n    });\n  }\n}\nLoginServiceService.ɵfac = function LoginServiceService_Factory(t) {\n  return new (t || LoginServiceService)(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.LocalStorageService), i0.ɵɵinject(i2.SessionStorageService), i0.ɵɵinject(i3.StateStorageService), i0.ɵɵinject(i4.Router));\n};\nLoginServiceService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: LoginServiceService,\n  factory: LoginServiceService.ɵfac,\n  providedIn: 'root'\n});\nexport { LoginServiceService };","map":{"version":3,"names":["Observable","ReplaySubject","catchError","map","mergeMap","of","shareReplay","tap","Account","HttpParams","LoginServiceService","constructor","httpclient","localStorageService","sessionStorageService","stateStorageService","router","userIdentity","authenticationState","url","url1","url2","register","data","post","login","pass","remember","pipe","response","authenticateUser","token","rememberMe","identity","googleLogin","googleToken","queryParams","set","console","log","get","params","fbLogin","name","qParam","jwt","store","clear","force","accountCache$","fetch","account","authenticate","navigateToStoredUrl","next","x","subscribe","a","b","userId","localStorage","setItem","previousUrl","getUrl","clearUrl","navigateByUrl","isAuthenticated","getItem","out","observer","removeItem","complete","logout","i0","ɵɵinject","i1","HttpClient","i2","LocalStorageService","SessionStorageService","i3","StateStorageService","i4","Router","factory","ɵfac","providedIn"],"sources":["C:\\MMY Project\\MakeMyYatraa\\Frontend\\Data0\\src\\app\\Services\\login-service.service.ts"],"sourcesContent":["import { HttpClient } from '@angular/common/http';\nimport { Injectable } from '@angular/core';\nimport { Observable, ReplaySubject, catchError, map, mergeMap, of, shareReplay, tap } from 'rxjs';\nimport { Reg } from '../Domain/General-Domain/Reg';\nimport { Login } from '../Domain/General-Domain/Login';\nimport { LocalStorageService, SessionStorageService } from 'ngx-webstorage';\nimport { Account } from '../Domain/General-Domain/Account';\nimport { StateStorageService } from './Auth/state-storage.service';\nimport { Router } from '@angular/router';\nimport {HttpParams} from '@angular/common/http';\ntype JwtToken={\n  token:string;\n}\n@Injectable({\n  providedIn: 'root'\n})\nexport class LoginServiceService {\n  private accountCache$?: Observable<Account> | null;\n  private userIdentity: Account | null = null;\n  private authenticationState = new ReplaySubject<Account | null>(1);\n  \n  constructor(\n    private httpclient:HttpClient,\n    private localStorageService: LocalStorageService,\n    private sessionStorageService: SessionStorageService,\n    private stateStorageService: StateStorageService,\n    private router: Router\n    ) { }\n  url=\"http://localhost:9000/api/v1/login\";\n  url1=\"http://localhost:9000/api/v1\";\n  url2=\"http://localhost:9000/api\";\n  register(data:Reg):Observable<Reg>{\n    return this.httpclient.post<Reg>(`${this.url1}/${\"register\"}`,data);\n  }\n  login(data:number,pass:FormData,remember:Login):Observable<Account | null>{\n    return this.httpclient.post<any>(`${this.url}/${data}`,pass).\n    pipe(map(response => this.authenticateUser(response.token, remember.rememberMe))).pipe(mergeMap(() => this.identity(data, true)));\n  }\n  googleLogin(googleToken):Observable<Account | null> {\n    const queryParams = new HttpParams().set('token', googleToken)\n    console.log(\"Sanity\", queryParams)\n    return this.httpclient.get<any>(`${this.url1}/${\"google\"}`, {params: queryParams});\n  }\n  fbLogin(name):Observable<Account | null> {\n    const qParam = new HttpParams().set('name', name);\n    console.log(\"name\", name)\n    return this.httpclient.get<any>(`${this.url1}/${\"facebook\"}`, {params: qParam});\n  }\n  authenticateUser(response: any, rememberMe: boolean):void {\n  \n    const jwt = response;\n    if(rememberMe) {\n      console.log(\"token1\",jwt);\n      this.localStorageService.store('authenticationToken', jwt);\n      this.sessionStorageService.clear('authenticationToken');\n    } else{\n      console.log(\"token2\", jwt);\n      this.sessionStorageService.store('authenticationToken', jwt);\n      this.localStorageService.clear('authenticationToken');\n    }\n  }\n   identity(data?: any,force?: boolean): Observable<Account | null> {\n    if (!this.accountCache$ || force && data!=null) {\n      this.accountCache$ = this.fetch(data).pipe(\n        tap((account: Account) => {\n          this.authenticate(account);\n\n          this.navigateToStoredUrl();\n        }),\n        shareReplay()\n      );\n    \n  }\n    return this.accountCache$.pipe(catchError(() => of(null)));\n  }\n   authenticate(identity: Account | null): void {\n    this.userIdentity = identity;\n    console.log(\"id1\", this.userIdentity);\n    this.authenticationState.next(identity);\n    if(!identity) {\n        this.accountCache$ = null;\n    }\n  }\n  private fetch(data: any): Observable<Account> {\n    if(data!=null){\n    let x = this.httpclient.get<Account>(`${this.url1}/${\"fetch\"}/${data}`);\n    if(x!==null){\n      x.subscribe(a=>{\n        let b = a.userId;\n        console.log(\"id2\", b);\n        localStorage.setItem(\"userIdentity\", b);\n      })\n    }\n    return x;\n  }else{\n    return Observable<Account\n  }\n  }\n  private navigateToStoredUrl(): void {\n    // previousState can be set in the authExpiredInterceptor and in the userRouteAccessService\n    // if login is successful, go to stored previousState and clear previousState\n    const previousUrl = this.stateStorageService.getUrl();\n    if (previousUrl) {\n      this.stateStorageService.clearUrl();\n      this.router.navigateByUrl(previousUrl);\n    }\n  }\n  isAuthenticated(): boolean {\n    let userIdentity = localStorage.getItem(\"userIdentity\")\n    if(userIdentity!==null) {\n      console.log(\"id\", userIdentity)\n      return true;\n    }else{ \n      console.log(\"else\", userIdentity)\n      return false;\n    }\n  }\n\n  out(): Observable<void> {\n    return new Observable(observer =>{\n      this.localStorageService.clear();\n      this.sessionStorageService.clear();\n      localStorage.removeItem(\"userIdentity\");\n      observer.complete();\n    })\n  }\n  logout(): void{\n    this.out().subscribe({ complete: () => this.authenticate(null)})\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}